<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokki's Pixel Journal ğŸ¾</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --pixel-border: 2px solid #000; --bg-color: #f4f1ea; }
        body { background-color: var(--bg-color); background-image: radial-gradient(#d1c7b7 1px, transparent 1px); background-size: 20px 20px; font-family: 'Courier New', Courier, sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* ğŸ—“ï¸ æœˆä»½å¯¼èˆªä¿®å¤ */
        .month-selector { display: flex; gap: 10px; overflow-x: auto; width: 100%; max-width: 450px; padding: 15px 5px; }
        .month-tab { background: white; border: var(--pixel-border); padding: 8px 15px; cursor: pointer; font-weight: bold; box-shadow: 3px 3px 0px #000; white-space: nowrap; }
        .month-tab.active { background: #ffcc00; transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }

        /* ğŸ“¸ ç…§ç‰‡ç½‘æ ¼ */
        .photo-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; max-width: 500px; padding-bottom: 100px; }
        .polaroid { background: #fffdf5; border: var(--pixel-border); padding: 10px 10px 20px 10px; width: calc(50% - 10px); box-shadow: 4px 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; image-rendering: pixelated; }
        .polaroid img { width: 100%; border: var(--pixel-border); aspect-ratio: 1/1; object-fit: cover; }
        .polaroid-info { text-align: center; margin-top: 10px; font-size: 0.75rem; color: #444; border-top: 1px dashed #eee; padding-top: 5px; }

        /* â• ä¸Šä¼ é¢æ¿ */
        #upload-panel { display: none; background: white; border: var(--pixel-border); padding: 20px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 85%; max-width: 300px; box-shadow: 10px 10px 0px #000; }
        input { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; box-sizing: border-box; }
        .floating-add { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: #1a1a1a; color: #ffcc00; border-radius: 50%; border: var(--pixel-border); display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="music-container" style="width: 100%; max-width: 400px; margin-bottom: 20px;">
        <p style="text-align:center; font-size:12px;">åŠ è½½éŸ³ä¹ä¸­...ğŸ¾</p>
    </div>

    <div class="month-selector" id="month-nav">
        <div class="month-tab active" onclick="switchMonth('2026-01', this)">2026.01</div>
        <div class="month-tab" onclick="switchMonth('2026-02', this)">2026.02</div>
        <div class="month-tab" onclick="switchMonth('2026-03', this)">2026.03</div>
    </div>

    <div class="photo-grid" id="photo-display"></div>

    <div id="upload-panel">
        <h3 style="margin:0 0 10px 0">ğŸ¾ å‘å¸ƒæ–°è®°å½•</h3>
        <input type="text" id="img-url" placeholder="å›¾ç‰‡é“¾æ¥ (ä¾‹å¦‚ 1.jpeg æˆ–ç½‘ç»œé“¾æ¥)">
        <input type="text" id="music-url" placeholder="Spotify é“¾æ¥ (ä¾‹å¦‚ http://googleusercontent.com/spotify.com/7)">
        <input type="text" id="img-desc" placeholder="å†™ç‚¹ä»€ä¹ˆå‘¢...">
        <button onclick="saveEntry()" style="width:100%; background:#000; color:#fff; padding:12px; border:none; cursor:pointer; font-weight:bold;">ç¡®è®¤å‘å¸ƒ</button>
        <button onclick="document.getElementById('upload-panel').style.display='none'" style="width:100%; background:none; border:none; color:#666; margin-top:10px;">å–æ¶ˆ</button>
    </div>

    <div class="floating-add" onclick="document.getElementById('upload-panel').style.display='block'">ğŸ¾</div>

    <script>
        const SB_URL = 'https://cqnqeithtxwsribvkpdu.supabase.co';
        const SB_KEY = 'sb_publishable_rAGZrZ7_xj5BukT4OJwrXA_f4bogSrm';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);
        let currentActiveMonth = '2026-01';

        async function fetchEntries() {
            const container = document.getElementById('photo-display');
            const musicContainer = document.getElementById('music-container');
            
            const { data, error } = await supabaseClient
                .from('journal_entries')
                .select('*')
                .eq('month', currentActiveMonth)
                .order('created_at', { ascending: true });

            container.innerHTML = '';
            
            if (data && data.length > 0) {
                // åŠ è½½è¯¥æœˆæœ€æ–°çš„éŸ³ä¹
                const entryWithMusic = [...data].reverse().find(item => item.music_url);
                if (entryWithMusic) {
                    musicContainer.innerHTML = `<iframe style="border-radius:12px" src="${entryWithMusic.music_url}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                } else {
                    musicContainer.innerHTML = `<p style="text-align:center; font-size:12px;">æœ¬æœˆæš‚æ— èƒŒæ™¯éŸ³ä¹</p>`;
                }

                data.forEach(item => {
                    container.innerHTML += `<div class="polaroid"><img src="${item.image_url}"><div class="polaroid-info">${item.description}</div></div>`;
                });
            } else {
                container.innerHTML = '<p style="color:#999; margin-top:50px">è¿™ä¸ªæœˆè¿˜æ²¡æœ‰è®°å½•å“¦ ğŸ¾</p>';
                musicContainer.innerHTML = `<p style="text-align:center; font-size:12px;">æœ¬æœˆæš‚æ— èƒŒæ™¯éŸ³ä¹</p>`;
            }
        }

        async function saveEntry() {
            const url = document.getElementById('img-url').value;
            const mUrl = document.getElementById('music-url').value;
            const desc = document.getElementById('img-desc').value;
            if (!url) return alert('å›¾ç‰‡é“¾æ¥ä¸èƒ½ç©ºç€å“¦ï¼');

            const { error } = await supabaseClient.from('journal_entries').insert([{ 
                image_url: url, 
                music_url: mUrl, 
                description: desc, 
                month: currentActiveMonth 
            }]);

            if (!error) {
                location.reload();
            } else {
                alert('ä¸Šä¼ å¤±è´¥ï¼Œè¯·ç¡®è®¤æ•°æ®åº“æƒé™å·²å¼€å¯ã€‚');
            }
        }

        function switchMonth(month, el) {
            currentActiveMonth = month;
            document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            fetchEntries();
        }

        fetchEntries();
    </script>
</body>
</html>
