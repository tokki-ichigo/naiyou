<script>
    async function fetchEntries() {
        const container = document.getElementById('photo-display');
        const musicContainer = document.getElementById('music-container');
        
        const { data, error } = await supabaseClient
            .from('journal_entries')
            .select('*')
            .eq('month', currentActiveMonth)
            .order('created_at', { ascending: true });

        container.innerHTML = '';
        
        if (data && data.length > 0) {
            // æ‰¾åˆ°è¯¥æœˆæœ€æ–°çš„ä¸€æ¡å¸¦é“¾æ¥çš„éŸ³ä¹è®°å½•
            let latestMusic = [...data].reverse().find(item => item.music_url && item.music_url.trim() !== "");
            
            if (latestMusic) {
                let mUrl = latestMusic.music_url;
                // è‡ªåŠ¨ä¿®å¤é“¾æ¥æ ¼å¼ï¼šå¦‚æœæ˜¯æ™®é€šé“¾æ¥ï¼Œè‡ªåŠ¨è½¬ä¸ºåµŒå…¥æ ¼å¼
                if (mUrl.includes('open.spotify.com') && !mUrl.includes('/embed/')) {
                    mUrl = mUrl.replace('open.spotify.com/', 'open.spotify.com/embed/');
                }
                musicContainer.innerHTML = `<iframe style="border-radius:12px" src="${mUrl}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
            } else {
                musicContainer.innerHTML = `<p style="font-size:12px; color:#666;">ğŸµ è¿™ä¸€æœˆè¿˜æ²¡æœ‰ BGM å“¦</p>`;
            }

            data.forEach(item => {
                // åªæœ‰å½“ image_url åŒ…å«å›¾ç‰‡ç‰¹å¾æ—¶æ‰æ˜¾ç¤ºï¼Œé˜²æ­¢ä¹‹å‰çš„é”™è¯¯æ•°æ®å¹²æ‰°
                if (item.image_url && (item.image_url.includes('.') || item.image_url.length < 20)) {
                    container.innerHTML += `
                        <div class="polaroid">
                            <img src="${item.image_url.includes('http') ? item.image_url : './' + item.image_url}" onerror="this.src='https://via.placeholder.com/150?text=Image+Error'">
                            <div class="polaroid-info">${item.description || 'ğŸ¾'}</div>
                        </div>`;
                }
            });
        } else {
            container.innerHTML = `<p style="color:#999; margin-top:50px">è¿˜æ²¡æœ‰è®°å½•å‘¢ ğŸ¾</p>`;
            musicContainer.innerHTML = `<p style="font-size:11px; color:#999;">ç­‰å¾…éŸ³ä¹å“èµ·...</p>`;
        }
    }
</script>
