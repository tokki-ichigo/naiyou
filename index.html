<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tokki's Pixel Journal ğŸ¾</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --pixel-border: 2px solid #000; --bg-color: #f4f1ea; }
        body { background-color: var(--bg-color); background-image: radial-gradient(#d1c7b7 1px, transparent 1px); background-size: 20px 20px; font-family: 'Courier New', Courier, sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        
        /* ğŸµ éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ */
        #music-container { width: 100%; max-width: 400px; min-height: 152px; margin-bottom: 25px; border-radius: 12px; overflow: hidden; background: rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: center; }

        /* ğŸ—“ï¸ æœˆä»½å¯¼èˆª (å·²ä¿®å¤ 03 æœˆ) */
        .month-selector { display: flex; gap: 10px; overflow-x: auto; width: 100%; max-width: 450px; padding: 15px 5px; margin-bottom: 20px; }
        .month-tab { background: white; border: var(--pixel-border); padding: 8px 15px; cursor: pointer; font-weight: bold; box-shadow: 3px 3px 0px #000; white-space: nowrap; transition: 0.2s; }
        .month-tab.active { background: #ffcc00; transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }

        /* ğŸ“¸ ç…§ç‰‡ç½‘æ ¼ */
        .photo-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; max-width: 500px; padding-bottom: 100px; }
        .polaroid { background: #fffdf5; border: var(--pixel-border); padding: 10px 10px 20px 10px; width: calc(50% - 10px); box-shadow: 4px 4px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; image-rendering: pixelated; }
        .polaroid img { width: 100%; border: var(--pixel-border); aspect-ratio: 1/1; object-fit: cover; }
        .polaroid-info { text-align: center; margin-top: 10px; font-size: 0.75rem; color: #444; border-top: 1px dashed #eee; padding-top: 5px; }

        /* âœï¸ ä¸Šä¼ é¢æ¿ */
        #upload-panel { display: none; background: white; border: var(--pixel-border); padding: 20px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; width: 85%; max-width: 300px; box-shadow: 10px 10px 0px #000; }
        input { width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit; }
        .floating-add { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: #1a1a1a; color: #ffcc00; border-radius: 50%; border: var(--pixel-border); display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
    </style>
</head>
<body>

    <div id="music-container">
        <p style="font-size: 12px; color: #666;">æ­£åœ¨åŠ è½½æœ¬æœˆ BGM...ğŸ¾</p>
    </div>

    <div class="month-selector">
        <div class="month-tab active" onclick="switchMonth('2026-01', this)">2026.01</div>
        <div class="month-tab" onclick="switchMonth('2026-02', this)">2026.02</div>
        <div class="month-tab" onclick="switchMonth('2026-03', this)">2026.03</div>
    </div>

    <div class="photo-grid" id="photo-display"></div>

    <div id="upload-panel">
        <h3 style="margin-top:0;">ğŸ¾ æ–°å¢è®°å½•</h3>
        <input type="text" id="img-url" placeholder="å›¾ç‰‡é“¾æ¥">
        <input type="text" id="music-url" placeholder="Spotify åµŒå…¥é“¾æ¥ (é€‰å¡«)">
        <input type="text" id="img-desc" placeholder="æ­¤åˆ»çš„å¿ƒæƒ…...">
        <button onclick="saveEntry()" style="width:100%; background:#000; color:#fff; padding:12px; border:none; cursor:pointer; font-weight:bold;">å‘å¸ƒ</button>
        <button onclick="document.getElementById('upload-panel').style.display='none'" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>

    <div class="floating-add" onclick="document.getElementById('upload-panel').style.display='block'">ğŸ¾</div>

    <script>
        // ğŸ”‘ ä½ çš„ Supabase é…ç½®
        const SB_URL = 'https://cqnqeithtxwsribvkpdu.supabase.co';
        const SB_KEY = 'sb_publishable_rAGZrZ7_xj5BukT4OJwrXA_f4bogSrm';
        const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

        let currentActiveMonth = '2026-01';

        async function fetchEntries() {
            const container = document.getElementById('photo-display');
            const musicContainer = document.getElementById('music-container');
            
            const { data, error } = await supabaseClient
                .from('journal_entries')
                .select('*')
                .eq('month', currentActiveMonth)
                .order('created_at', { ascending: true });

            container.innerHTML = '';
            
            if (data && data.length > 0) {
                // æŸ¥æ‰¾è¯¥æœˆæœ€æ–°çš„éŸ³ä¹é“¾æ¥
                const entryWithMusic = [...data].reverse().find(item => item.music_url && item.music_url.includes('http'));
                if (entryWithMusic) {
                    musicContainer.innerHTML = `<iframe style="border-radius:12px" src="${entryWithMusic.music_url}" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>`;
                } else {
                    musicContainer.innerHTML = `<p style="font-size:12px; color:#666;">è¿™ä¸ªæœˆè¿˜æ²¡æœ‰è®¾ç½® BGM å‘¢ ğŸµ</p>`;
                }

                data.forEach(item => {
                    container.innerHTML += `
                        <div class="polaroid">
                            <img src="${item.image_url}" onerror="this.src='https://via.placeholder.com/150?text=Image+Error'">
                            <div class="polaroid-info">${item.description || 'ğŸ¾'}</div>
                        </div>`;
                });
            } else {
                container.innerHTML = '<p style="color:#999; margin-top:50px">è¿™ä¸ªæœˆç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«å»å–‚ç…§ç‰‡å§ï¼ğŸ¾</p>';
                musicContainer.innerHTML = `<p style="font-size:12px; color:#666;">ç­‰å¾…éŸ³ä¹ä¸­...</p>`;
            }
        }

        async function saveEntry() {
            const url = document.getElementById('img-url').value;
            const mUrl = document.getElementById('music-url').value;
            const desc = document.getElementById('img-desc').value;
            
            if (!url) return alert('å›¾ç‰‡é“¾æ¥æ˜¯å¿…å¡«çš„å“¦ï¼');

            const { error } = await supabaseClient.from('journal_entries').insert([{ 
                image_url: url, 
                music_url: mUrl, 
                description: desc, 
                month: currentActiveMonth 
            }]);

            if (!error) {
                document.getElementById('upload-panel').style.display = 'none';
                location.reload(); // åˆ·æ–°ä»¥çœ‹åˆ°æ–°å†…å®¹
            } else {
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“ Policy è®¾ç½®ã€‚');
            }
        }

        function switchMonth(month, el) {
            currentActiveMonth = month;
            document.querySelectorAll('.month-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            fetchEntries();
        }

        fetchEntries();
    </script>
</body>
</html>
